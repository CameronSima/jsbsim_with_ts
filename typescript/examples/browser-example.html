<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSBSim Browser Example</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 10px 0;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.loading {
        background: #fff3cd;
        color: #856404;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #0056b3;
      }
      .data-display {
        background: white;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-line;
      }
      .property-input {
        margin: 10px 0;
      }
      .property-input input,
      .property-input select {
        margin: 0 5px;
        padding: 5px;
      }

      /* Flight Control Styles */
      .flight-controls {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        margin: 20px 0;
      }

      .mouse-control-area {
        border: 2px solid #007bff;
        border-radius: 8px;
        height: 300px;
        position: relative;
        background: linear-gradient(to bottom, #87ceeb 0%, #98fb98 100%);
        cursor: crosshair;
        overflow: hidden;
      }

      .mouse-control-area:hover {
        border-color: #0056b3;
      }

      .control-crosshair {
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(255, 0, 0, 0.8);
        border: 2px solid white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        transition: all 0.1s ease;
      }

      .control-instructions {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
      }

      /* Navball and Instruments */
      .instruments-panel {
        display: grid;
        grid-template-rows: 200px 1fr;
        gap: 10px;
      }

      .navball {
        width: 200px;
        height: 200px;
        border: 3px solid #333;
        border-radius: 50%;
        position: relative;
        background: radial-gradient(circle at center, #001122 0%, #003366 100%);
        margin: 0 auto;
        overflow: hidden;
      }

      .navball-horizon {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        background: linear-gradient(to bottom, #87ceeb 0%, #87ceeb 50%, #8b4513 50%, #8b4513 100%);
        transform-origin: center center;
        transition: transform 0.1s ease;
      }

      .navball-attitude {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }

      .navball-marker {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 6px;
        height: 6px;
        background: #ff0000;
        border: 1px solid white;
        border-radius: 50%;
        z-index: 10;
      }

      .navball-roll-indicator {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 20px;
        background: #ffff00;
        z-index: 5;
      }

      .flight-data {
        background: #1a1a1a;
        color: #00ff00;
        padding: 10px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.3;
      }

      .flight-data .data-row {
        display: flex;
        justify-content: space-between;
        margin: 2px 0;
      }

      .flight-data .data-label {
        color: #ffff00;
      }

      .throttle-control {
        writing-mode: bt-lr;
        -webkit-appearance: slider-vertical;
        width: 30px;
        height: 200px;
        background: #333;
        outline: none;
      }
    </style>
  </head>
  <body>
    <h1>JSBSim Browser Example</h1>

    <div class="container">
      <h2>Flight Dynamics Simulation in Your Browser</h2>
      <p>
        This example demonstrates JSBSim running in WebAssembly within a web
        browser.
      </p>

      <div id="status" class="status loading">Initializing JSBSim...</div>

      <div class="container">
        <h3>Aircraft Selection</h3>
        <div class="property-input">
          <label for="aircraftSelect">Available Aircraft:</label>
          <select id="aircraftSelect" onchange="onAircraftSelectionChange()" disabled>
            <option value="">-- Select Aircraft --</option>
            <option value="c172x">Cessna 172 (Extended)</option>
            <option value="c172p">Cessna 172P</option>
            <option value="c172r">Cessna 172R</option>
            <option value="c182">Cessna 182</option>
            <option value="c310">Cessna 310</option>
            <option value="pa28">Piper Cherokee</option>
            <option value="J3Cub">Piper J3 Cub</option>
            <option value="737">Boeing 737</option>
            <option value="787-8">Boeing 787-8</option>
            <option value="B747">Boeing 747</option>
            <option value="A320">Airbus A320</option>
            <option value="f16">F-16 Fighting Falcon</option>
            <option value="f15">F-15 Eagle</option>
            <option value="f22">F-22 Raptor</option>
            <option value="p51d">P-51D Mustang</option>
            <option value="t6texan2">T-6 Texan II</option>
            <option value="Concorde">Concorde</option>
            <option value="X15">X-15</option>
            <option value="demo">Demo Mode (No Aircraft)</option>
          </select>
          <span id="selectedAircraft">None</span>
        </div>
      </div>

      <div class="controls">
        <button id="initBtn" onclick="initializeJSBSim()" disabled>
          Initialize JSBSim
        </button>
        <button id="loadAircraftBtn" onclick="loadAircraft()" disabled>
          Load Aircraft
        </button>
        <button id="runSimBtn" onclick="runSimulation()" disabled>
          Run Simulation
        </button>
        <button id="stepBtn" onclick="stepSimulation()" disabled>
          Single Step
        </button>
        <button id="resetBtn" onclick="resetSimulation()" disabled>
          Reset
        </button>
      </div>

      <div class="property-input">
        <label>Flight Controls:</label>
        <div>
          Elevator:
          <input
            type="range"
            id="elevatorSlider"
            min="-1"
            max="1"
            step="0.1"
            value="0"
            onchange="setElevator()" />
          <span id="elevatorValue">0.0</span>
        </div>
        <div>
          Aileron:
          <input
            type="range"
            id="aileronSlider"
            min="-1"
            max="1"
            step="0.1"
            value="0"
            onchange="setAileron()" />
          <span id="aileronValue">0.0</span>
        </div>
        <div>
          Rudder:
          <input
            type="range"
            id="rudderSlider"
            min="-1"
            max="1"
            step="0.1"
            value="0"
            onchange="setRudder()" />
          <span id="rudderValue">0.0</span>
        </div>
        <div>
          Throttle:
          <input
            type="range"
            id="throttleSlider"
            min="0"
            max="1"
            step="0.1"
            value="0.7"
            onchange="setThrottle()" />
          <span id="throttleValue">0.7</span>
        </div>
        <div>
          Flaps:
          <input
            type="range"
            id="flapsSlider"
            min="0"
            max="1"
            step="0.1"
            value="0"
            onchange="setFlaps()" />
          <span id="flapsValue">0.0</span>
        </div>
      </div>

      <div class="property-input">
        <label>Engine Controls:</label>
        <button onclick="startEngine()">Start Engine</button>
        <button onclick="stopEngine()">Stop Engine</button>
        <span id="engineStatus">Stopped</span>
      </div>

      <div class="property-input">
        <label>Landing Gear:</label>
        <button onclick="toggleGear()">Toggle Gear</button>
        <span id="gearStatus">Down</span>
      </div>

      <div class="property-input">
        <label>Manual Property:</label>
        <input
          type="text"
          id="propertyName"
          placeholder="property/name"
          value="ic/h-sl-ft" />
        <input
          type="number"
          id="propertyValue"
          placeholder="value"
          value="5000" />
        <button onclick="setProperty()">Set</button>
      </div>

      <!-- Enhanced Flight Controls -->
      <div class="container">
        <h3>Flight Controls</h3>
        <div class="flight-controls">
          <div>
            <h4>Mouse Flight Control</h4>
            <div class="mouse-control-area" id="mouseControlArea">
              <div class="control-instructions">
                Move mouse: Pitch/Roll<br>
                Click: Center controls<br>
                Mouse wheel: Rudder
              </div>
              <div class="control-crosshair" id="controlCrosshair"></div>
            </div>
            <div style="margin-top: 10px;">
              <label>Throttle: </label>
              <input type="range" id="throttleSliderNew" min="0" max="1" step="0.05" value="0.7"
                     style="width: 200px;" onchange="setThrottleFromSlider()">
              <span id="throttleValueNew">70%</span>
            </div>
          </div>

          <div class="instruments-panel">
            <div>
              <h4>Attitude Indicator</h4>
              <div class="navball" id="navball">
                <div class="navball-horizon" id="navballHorizon"></div>
                <div class="navball-attitude" id="navballAttitude"></div>
                <div class="navball-marker"></div>
                <div class="navball-roll-indicator" id="rollIndicator"></div>
              </div>
            </div>

            <div class="flight-data" id="flightData">
              <div class="data-row">
                <span class="data-label">ALT:</span>
                <span id="altitude">0 ft</span>
              </div>
              <div class="data-row">
                <span class="data-label">SPD:</span>
                <span id="airspeed">0 kts</span>
              </div>
              <div class="data-row">
                <span class="data-label">HDG:</span>
                <span id="heading">0°</span>
              </div>
              <div class="data-row">
                <span class="data-label">ATT:</span>
                <span id="attitude">0° 0° 0°</span>
              </div>
              <div class="data-row">
                <span class="data-label">THR:</span>
                <span id="thrustDisplay">0 lbs</span>
              </div>
              <div class="data-row">
                <span class="data-label">FUEL:</span>
                <span id="fuelDisplay">0 lbs</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <h3>Simulation Data</h3>
        <div id="simulationData" class="data-display">No data available</div>
      </div>

      <div class="container">
        <h3>Console Output</h3>
        <div id="consoleOutput" class="data-display">
          Ready to start simulation...
        </div>
      </div>
    </div>

    <!-- Load JSBSim WebAssembly module as ES6 module and expose globally -->
    <script type="module">
      import JSBSimModule from '/dist/jsbsim.js';

      // Create a wrapper that ensures the module loads from the correct path
      window.JSBSimModule = async (moduleOverrides = {}) => {
        console.log('HTML wrapper: Creating JSBSim module with overrides...');

        // Set the correct path for loading the .data file
        const defaultOverrides = {
          locateFile: (path, scriptDirectory) => {
            console.log('locateFile called with:', path, 'scriptDirectory:', scriptDirectory);
            if (path.endsWith('.data') || path.endsWith('.wasm')) {
              const fullPath = '/dist/' + path;
              console.log('Redirecting to:', fullPath);
              return fullPath;
            }
            return scriptDirectory + path;
          }
        };

        // Merge with any user-provided overrides
        const finalOverrides = { ...defaultOverrides, ...moduleOverrides };

        console.log('HTML wrapper: Calling original JSBSimModule...');
        try {
          const result = await JSBSimModule(finalOverrides);
          console.log('HTML wrapper: JSBSimModule created successfully');
          return result;
        } catch (error) {
          console.error('HTML wrapper: Error creating JSBSimModule:', error);
          throw error;
        }
      };

      console.log('JSBSim WebAssembly module loaded and exposed globally');
    </script>
    <!-- Load the TypeScript bundle -->
    <script src="/dist/jsbsim.bundle.js"></script>

    <script>
      let jsbsim = null;
      let simulationRunning = false;
      let simulationTimer = null;

      function log(message) {
        const consoleOutput = document.getElementById("consoleOutput");
        const timestamp = new Date().toLocaleTimeString();
        consoleOutput.textContent += `[${timestamp}] ${message}\n`;
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
        console.log(message);
      }

      function updateStatus(message, type = "loading") {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      function enableButton(id, enabled = true) {
        document.getElementById(id).disabled = !enabled;
      }

      async function initializeJSBSim() {
        try {
          updateStatus("Initializing JSBSim WebAssembly module...", "loading");
          log("Starting JSBSim initialization...");

          jsbsim = new JSBSim();

          // Initialize JSBSim
          await jsbsim.init({
            // Aircraft data is now embedded in the WebAssembly build
          });

          log("JSBSim initialized successfully");
          updateStatus("JSBSim initialized successfully", "success");

          enableButton("loadAircraftBtn", false); // Keep disabled until aircraft selected
          enableButton("initBtn", false);
          document.getElementById("aircraftSelect").disabled = false;

          // Display JSBSim version
          const fdm = jsbsim.getFDM();
          const version = fdm.getVersion();
          log(`JSBSim version: ${version}`);
        } catch (error) {
          console.error('Full initialization error:', error);
          log(`Initialization failed: ${error.message || error}`);
          updateStatus(`Initialization failed: ${error.message || error}`, "error");
        }
      }

      function onAircraftSelectionChange() {
        const select = document.getElementById("aircraftSelect");
        const selectedValue = select.value;
        document.getElementById("selectedAircraft").textContent =
          selectedValue ? select.options[select.selectedIndex].text : "None";

        // Enable load button if an aircraft is selected
        enableButton("loadAircraftBtn", selectedValue !== "");
      }

      async function loadAircraft() {
        const select = document.getElementById("aircraftSelect");
        const selectedAircraft = select.value;

        if (!selectedAircraft) {
          log("Please select an aircraft first");
          return;
        }

        try {
          if (selectedAircraft === "demo") {
            // Demo mode - no aircraft loading
            updateStatus("Setting up demo simulation...", "loading");
            log("Setting up demo simulation without aircraft model...");

            // Enable simulation controls immediately
            enableButton("runSimBtn");
            enableButton("stepBtn");
            enableButton("resetBtn");
            enableButton("loadAircraftBtn", false);
            document.getElementById("aircraftSelect").disabled = true;

            // Set up basic initial conditions
            try {
              jsbsim.setProperty("simulation/sim-time-sec", 0.0);
              jsbsim.setProperty("simulation/dt", 0.1);
              log("Basic simulation properties set");
            } catch (error) {
              log(`Warning: Could not set initial properties: ${error.message}`);
            }

            log("Demo simulation ready");
            updateStatus("Demo simulation ready", "success");
            updateSimulationData();

          } else {
            // Load actual aircraft using embedded data
            updateStatus(`Loading aircraft: ${selectedAircraft}...`, "loading");
            log(`Loading aircraft: ${selectedAircraft} from embedded data...`);

            // Try to load the aircraft directly (data is now embedded in WASM)
            const loaded = jsbsim.loadAircraft(selectedAircraft);

            if (loaded) {
              log(`Aircraft ${selectedAircraft} loaded successfully!`);
              updateStatus(`Aircraft ${selectedAircraft} loaded successfully`, "success");

              // Enable simulation controls
              enableButton("runSimBtn");
              enableButton("stepBtn");
              enableButton("resetBtn");
              enableButton("loadAircraftBtn", false);
              document.getElementById("aircraftSelect").disabled = true;

              // Set up initial conditions
              jsbsim.setProperty("ic/h-sl-ft", 5000);
              jsbsim.setProperty("ic/vc-kts", 120);

              const fdm = jsbsim.getFDM();

              // Initialize the simulation properly
              log("Running initial conditions...");
              fdm.runIC();

              // Run several simulation steps to initialize all systems
              log("Initializing aircraft systems...");
              for (let i = 0; i < 10; i++) {
                fdm.run();
              }

              // Ensure propulsion system is initialized
              try {
                const propulsion = fdm.getPropulsion();
                propulsion.initRunning(-1); // Initialize all engines in not-running state
                log("Propulsion system initialized");
              } catch (e) {
                log(`Warning: Could not initialize propulsion: ${e.message}`);
              }

              log("Initial conditions set");

              // Debug engine loading
              try {
                const propulsion = fdm.getPropulsion();
                const numEngines = propulsion.getNumEngines();
                log(`Propulsion system loaded: ${numEngines} engine(s) detected`);

                for (let i = 0; i < numEngines; i++) {
                  const engine = propulsion.getEngine(i);
                  const engineType = jsbsim.getEngineType(i);
                  log(`Engine ${i}: Type = ${engineType}, Running = ${jsbsim.isEngineRunning(i)}`);

                  // Check key engine properties
                  try {
                    const maxHP = jsbsim.getEngineMaxPowerHP(i);
                    const rpm = jsbsim.getEngineRPM(i);
                    log(`Engine ${i} properties: MaxHP = ${maxHP}, RPM = ${rpm}`);

                    // List all available properties for debugging
                    const props = jsbsim.getEnginePropertyList(i);
                    log(`Engine ${i} available properties: ${props.join(', ')}`);
                  } catch (e) {
                    log(`Engine ${i} property error: ${e.message}`);
                  }
                }
              } catch (e) {
                log(`Engine debug error: ${e.message}`);
              }

              updateSimulationData();
            } else {
              throw new Error(`JSBSim failed to load aircraft ${selectedAircraft}`);
            }
          }
        } catch (error) {
          log(`Aircraft loading failed: ${error.message}`);
          log("Try selecting 'Demo Mode (No Aircraft)' for testing without aircraft");
          updateStatus(`Loading failed: ${error.message}`, "error");
        }
      }

      function runSimulation() {
        if (simulationRunning) {
          // Stop simulation
          simulationRunning = false;
          clearInterval(simulationTimer);
          updateStatus("Simulation stopped", "success");
          document.getElementById("runSimBtn").textContent = "Run Simulation";
          log("Simulation stopped");
        } else {
          // Start simulation
          simulationRunning = true;
          updateStatus("Simulation running...", "loading");
          document.getElementById("runSimBtn").textContent = "Stop Simulation";
          log("Starting continuous simulation...");

          simulationTimer = setInterval(() => {
            try {
              const success = jsbsim.step();
              if (!success) {
                throw new Error("Simulation step failed");
              }
              updateSimulationData();
            } catch (error) {
              log(`Simulation error: ${error.message}`);
              simulationRunning = false;
              clearInterval(simulationTimer);
              updateStatus("Simulation error", "error");
              document.getElementById("runSimBtn").textContent =
                "Run Simulation";
            }
          }, 50); // 20 Hz update rate
        }
      }

      function stepSimulation() {
        try {
          const success = jsbsim.step();
          if (success) {
            updateSimulationData();
            log("Simulation stepped forward");
          } else {
            throw new Error("Simulation step failed");
          }
        } catch (error) {
          log(`Step failed: ${error.message}`);
          updateStatus(`Step failed: ${error.message}`, "error");
        }
      }

      function resetSimulation() {
        try {
          jsbsim.reset();
          updateSimulationData();
          log("Simulation reset to initial conditions");
          updateStatus("Simulation reset", "success");
        } catch (error) {
          log(`Reset failed: ${error.message}`);
          updateStatus(`Reset failed: ${error.message}`, "error");
        }
      }

      function setProperty() {
        try {
          const name = document.getElementById("propertyName").value;
          const value = parseFloat(
            document.getElementById("propertyValue").value
          );

          jsbsim.setProperty(name, value);
          log(`Set property ${name} = ${value}`);
          updateSimulationData();
        } catch (error) {
          log(`Failed to set property: ${error.message}`);
        }
      }

      function getProperty() {
        try {
          const name = document.getElementById("getPropertyName").value;
          const value = jsbsim.getProperty(name);

          document.getElementById("propertyResult").textContent =
            value.toFixed(6);
          log(`Got property ${name} = ${value}`);
        } catch (error) {
          log(`Failed to get property: ${error.message}`);
          document.getElementById("propertyResult").textContent = "Error";
        }
      }

      // Flight control functions using wrapper methods
      function setElevator() {
        if (!jsbsim) return;
        const value = parseFloat(
          document.getElementById("elevatorSlider").value
        );
        try {
          jsbsim.setElevator(value);
          document.getElementById("elevatorValue").textContent =
            value.toFixed(1);
          log(`Set elevator to ${value.toFixed(2)}`);
        } catch (error) {
          log(`Failed to set elevator: ${error.message}`);
        }
      }

      function setAileron() {
        if (!jsbsim) return;
        const value = parseFloat(
          document.getElementById("aileronSlider").value
        );
        try {
          jsbsim.setAileron(value);
          document.getElementById("aileronValue").textContent =
            value.toFixed(1);
          log(`Set aileron to ${value.toFixed(2)}`);
        } catch (error) {
          log(`Failed to set aileron: ${error.message}`);
        }
      }

      function setRudder() {
        if (!jsbsim) return;
        const value = parseFloat(document.getElementById("rudderSlider").value);
        try {
          jsbsim.setRudder(value);
          document.getElementById("rudderValue").textContent = value.toFixed(1);
          log(`Set rudder to ${value.toFixed(2)}`);
        } catch (error) {
          log(`Failed to set rudder: ${error.message}`);
        }
      }

      function setThrottle() {
        if (!jsbsim) return;
        const value = parseFloat(
          document.getElementById("throttleSlider").value
        );
        try {
          jsbsim.setAllThrottles(value);
          document.getElementById("throttleValue").textContent =
            value.toFixed(1);
          log(`Set throttle to ${value.toFixed(2)}`);
        } catch (error) {
          log(`Failed to set throttle: ${error.message}`);
        }
      }

      function setFlaps() {
        if (!jsbsim) return;
        const value = parseFloat(document.getElementById("flapsSlider").value);
        try {
          jsbsim.setFlaps(value);
          document.getElementById("flapsValue").textContent = value.toFixed(1);
          log(`Set flaps to ${value.toFixed(2)}`);
        } catch (error) {
          log(`Failed to set flaps: ${error.message}`);
        }
      }

      function startEngine() {
        if (!jsbsim) return;
        try {
          log("Starting engine procedure...");

          // Debug current engine state
          const propulsion = jsbsim.getFDM().getPropulsion();
          const numEngines = propulsion.getNumEngines();
          log(`Number of engines: ${numEngines}`);

          for (let i = 0; i < numEngines; i++) {
            const beforeRunning = jsbsim.isEngineRunning(i);
            log(`Engine ${i} running before start: ${beforeRunning}`);
          }

          // Try starting engines
          jsbsim.startAllEngines();

          // Check if engines started
          for (let i = 0; i < numEngines; i++) {
            const afterRunning = jsbsim.isEngineRunning(i);
            const rpm = jsbsim.getEngineRPM(i);
            const power = jsbsim.getEnginePowerHP(i);
            log(`Engine ${i} after start: running=${afterRunning}, rpm=${rpm}, power=${power}HP`);
          }

          // Set throttle
          jsbsim.setAllThrottles(0.8);
          log("Throttle set to 80%");

          // Run a few more simulation steps
          const fdm = jsbsim.getFDM();
          for (let step = 0; step < 10; step++) {
            fdm.run();
          }

          // Final check
          const finalRunning = jsbsim.isEngineRunning(0);
          const finalRPM = jsbsim.getEngineRPM(0);
          const finalPower = jsbsim.getEnginePowerHP(0);

          log(`Final engine state: running=${finalRunning}, rpm=${finalRPM}, power=${finalPower}HP`);

          document.getElementById("engineStatus").textContent = finalRunning ? "Running" : "Stopped";
          log(finalRunning ? "Engine started successfully" : "Engine failed to start");
        } catch (error) {
          log(`Failed to start engine: ${error.message}`);
        }
      }

      function stopEngine() {
        if (!jsbsim) return;
        try {
          jsbsim.stopAllEngines();
          jsbsim.setAllThrottles(0.0);
          document.getElementById("engineStatus").textContent = "Stopped";
          log("Engine stopped");
        } catch (error) {
          log(`Failed to stop engine: ${error.message}`);
        }
      }

      let gearUp = false;
      function toggleGear() {
        if (!jsbsim) return;
        try {
          gearUp = !gearUp;
          jsbsim.setLandingGear(gearUp ? 0.0 : 1.0);
          document.getElementById("gearStatus").textContent = gearUp
            ? "Up"
            : "Down";
          log(`Landing gear ${gearUp ? "retracted" : "extended"}`);
        } catch (error) {
          log(`Failed to toggle gear: ${error.message}`);
        }
      }

      function updateSimulationData() {
        if (!jsbsim) return;

        try {
          // Use wrapper methods for cleaner code
          const time = jsbsim.getTime();
          const position = jsbsim.getPosition();
          const attitude = jsbsim.getAttitude();
          const velocity = jsbsim.getVelocity();
          const rates = jsbsim.getAngularRates();
          const aero = {
            alpha: jsbsim.getAngleOfAttack(),
            beta: jsbsim.getSideslipAngle(),
            qbar: jsbsim.getDynamicPressure(),
          };

          // Get detailed engine status for all engines
          let engineInfo = "No engines";
          try {
            const propulsion = jsbsim.getFDM().getPropulsion();
            const numEngines = propulsion.getNumEngines();

            if (numEngines > 0) {
              let engines = [];
              for (let i = 0; i < numEngines; i++) {
                const running = jsbsim.isEngineRunning(i);
                const thrust = jsbsim.getEngineThrust(i);
                const rpm = jsbsim.getEngineRPM(i);
                const powerHP = jsbsim.getEnginePowerHP(i);
                const maxHP = jsbsim.getEngineMaxPowerHP(i);
                const fuelFlow = jsbsim.getEngineFuelFlow(i);
                const temperature = jsbsim.getEngineTemperature(i);
                const manifoldPressure = jsbsim.getEngineManifoldPressure(i);
                const n1 = jsbsim.getEngineN1(i);
                const n2 = jsbsim.getEngineN2(i);
                const engineType = jsbsim.getEngineType(i);

                let engineDetails = `Engine ${i + 1} (${engineType}): ${running ? "Running" : "Stopped"}`;
                engineDetails += `\n  RPM: ${rpm.toFixed(0)}`;
                engineDetails += `\n  Power: ${powerHP.toFixed(1)} HP`;
                if (maxHP > 0) engineDetails += ` / ${maxHP.toFixed(0)} HP max`;
                engineDetails += `\n  Thrust: ${thrust.toFixed(0)} lbs`;
                if (fuelFlow > 0) engineDetails += `\n  Fuel Flow: ${fuelFlow.toFixed(1)} lbs/hr`;
                if (temperature > 0) engineDetails += `\n  Temperature: ${temperature.toFixed(0)}°F`;
                if (manifoldPressure > 0) engineDetails += `\n  Manifold Pressure: ${manifoldPressure.toFixed(1)} inHg`;
                if (n1 > 0) engineDetails += `\n  N1: ${n1.toFixed(1)}%`;
                if (n2 > 0) engineDetails += `\n  N2: ${n2.toFixed(1)}%`;

                engines.push(engineDetails);
              }
              engineInfo = engines.join('\n\n');
            }
          } catch (e) {
            engineInfo = `Engine data error: ${e.message}`;
          }

          // Get gear status
          let gearInfo = "N/A";
          try {
            const gearPos = jsbsim.getLandingGearPosition();
            const onGround = jsbsim.isOnGround();
            gearInfo = `Gear: ${gearPos.toFixed(2)}, On Ground: ${onGround}`;
          } catch (e) {
            // Gear not available
          }

          const data = `Time: ${time.toFixed(2)} seconds

POSITION:
Latitude: ${position.latitude.toFixed(6)}°
Longitude: ${position.longitude.toFixed(6)}°
Altitude: ${position.altitude.toFixed(1)} ft MSL
AGL: ${jsbsim.getAltitudeAGL().toFixed(1)} ft

ATTITUDE:
Roll: ${attitude.roll.toFixed(1)}°
Pitch: ${attitude.pitch.toFixed(1)}°
Heading: ${attitude.yaw.toFixed(1)}°

VELOCITY:
Ground Speed: ${jsbsim.getGroundSpeed().toFixed(1)} fps
Airspeed: ${jsbsim.getCalibratedAirspeed().toFixed(1)} kts
True Airspeed: ${jsbsim.getTrueAirspeed().toFixed(1)} kts
Mach: ${jsbsim.getMachNumber().toFixed(3)}

ANGULAR RATES:
Roll Rate: ${rates.rollRate.toFixed(2)}°/s
Pitch Rate: ${rates.pitchRate.toFixed(2)}°/s
Yaw Rate: ${rates.yawRate.toFixed(2)}°/s

AERODYNAMICS:
Angle of Attack: ${aero.alpha.toFixed(2)}°
Sideslip: ${aero.beta.toFixed(2)}°
Dynamic Pressure: ${aero.qbar.toFixed(1)} psf

ENGINES:
${engineInfo}

SYSTEMS:
${gearInfo}
Fuel: ${jsbsim.getTotalFuel().toFixed(1)} lbs

CONTROLS:
Elevator: ${jsbsim.getElevatorPosition().toFixed(2)}
Aileron: ${jsbsim.getAileronPosition().toFixed(2)}
Rudder: ${jsbsim.getRudderPosition().toFixed(2)}
Flaps: ${jsbsim.getFlapsPosition().toFixed(2)}`;

          document.getElementById("simulationData").textContent = data;
        } catch (error) {
          document.getElementById(
            "simulationData"
          ).textContent = `Error reading data: ${error.message}`;
        }
      }

      // ========================================================================
      // Mouse Flight Controls and Visual Instruments
      // ========================================================================

      let mouseControlEnabled = false;
      let currentElevator = 0;
      let currentAileron = 0;
      let currentRudder = 0;

      function setupMouseControls() {
        const controlArea = document.getElementById('mouseControlArea');
        const crosshair = document.getElementById('controlCrosshair');

        // Set initial crosshair position (center)
        crosshair.style.left = '50%';
        crosshair.style.top = '50%';

        // Mouse move handler
        controlArea.addEventListener('mousemove', (e) => {
          if (!jsbsim) return;

          const rect = controlArea.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          // Convert to control values (-1 to 1)
          currentAileron = (x - 0.5) * 2;  // Left/right -> aileron
          currentElevator = -(y - 0.5) * 2; // Up/down -> elevator (inverted)

          // Clamp values
          currentAileron = Math.max(-1, Math.min(1, currentAileron));
          currentElevator = Math.max(-1, Math.min(1, currentElevator));

          // Update crosshair position
          crosshair.style.left = `${x * 100}%`;
          crosshair.style.top = `${y * 100}%`;

          // Apply controls
          try {
            jsbsim.setAileron(currentAileron);
            jsbsim.setElevator(currentElevator);
          } catch (error) {
            // Ignore errors if simulation not ready
          }
        });

        // Click to center controls
        controlArea.addEventListener('click', () => {
          currentAileron = 0;
          currentElevator = 0;
          currentRudder = 0;

          crosshair.style.left = '50%';
          crosshair.style.top = '50%';

          if (jsbsim) {
            try {
              jsbsim.setAileron(0);
              jsbsim.setElevator(0);
              jsbsim.setRudder(0);
            } catch (error) {
              // Ignore errors if simulation not ready
            }
          }
        });

        // Mouse wheel for rudder
        controlArea.addEventListener('wheel', (e) => {
          e.preventDefault();
          if (!jsbsim) return;

          const rudderDelta = e.deltaY > 0 ? 0.1 : -0.1;
          currentRudder = Math.max(-1, Math.min(1, currentRudder + rudderDelta));

          try {
            jsbsim.setRudder(currentRudder);
          } catch (error) {
            // Ignore errors if simulation not ready
          }
        });
      }

      function setThrottleFromSlider() {
        const slider = document.getElementById('throttleSliderNew');
        const display = document.getElementById('throttleValueNew');
        const value = parseFloat(slider.value);

        display.textContent = `${Math.round(value * 100)}%`;

        if (jsbsim) {
          try {
            jsbsim.setAllThrottles(value);
          } catch (error) {
            // Ignore errors if simulation not ready
          }
        }
      }

      function updateNavball() {
        if (!jsbsim) return;

        try {
          // Get aircraft attitude
          const attitude = jsbsim.getAttitude();
          const roll = attitude.roll;
          const pitch = attitude.pitch;
          const heading = attitude.yaw;

          // Update navball horizon
          const horizon = document.getElementById('navballHorizon');
          const rollIndicator = document.getElementById('rollIndicator');

          // Apply pitch and roll to horizon
          horizon.style.transform = `rotate(${-roll}deg) translateY(${pitch * 2}px)`;
          rollIndicator.style.transform = `translateX(-50%) rotate(${-roll}deg)`;

          // Update flight data display
          document.getElementById('altitude').textContent = `${Math.round(jsbsim.getAltitude())} ft`;
          document.getElementById('airspeed').textContent = `${Math.round(jsbsim.getCalibratedAirspeed())} kts`;
          document.getElementById('heading').textContent = `${Math.round(heading)}°`;
          document.getElementById('attitude').textContent = `${roll.toFixed(1)}° ${pitch.toFixed(1)}° ${heading.toFixed(1)}°`;

          // Engine data
          try {
            const thrust = jsbsim.getTotalThrust();
            const fuel = jsbsim.getTotalFuel();
            document.getElementById('thrustDisplay').textContent = `${Math.round(thrust)} lbs`;
            document.getElementById('fuelDisplay').textContent = `${Math.round(fuel)} lbs`;
          } catch (e) {
            // Engine data not available
          }

        } catch (error) {
          // Ignore errors if simulation not ready
        }
      }

      // Enhanced updateSimulationData that also updates instruments
      const originalUpdateSimulationData = updateSimulationData;
      updateSimulationData = function() {
        originalUpdateSimulationData();
        updateNavball();
      };

      // Initialize on page load
      window.addEventListener("load", () => {
        log("Page loaded, ready to initialize JSBSim");
        enableButton("initBtn");
        setupMouseControls();

        // Start updating navball even before simulation starts
        setInterval(updateNavball, 100); // Update at 10Hz
      });

      // Clean up on page unload
      window.addEventListener("beforeunload", () => {
        if (simulationRunning) {
          clearInterval(simulationTimer);
        }
      });
    </script>
  </body>
</html>
